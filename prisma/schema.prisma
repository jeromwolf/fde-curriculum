// Prisma Schema for FDE Academy
// PostgreSQL Database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management (NextAuth 호환)
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified DateTime?

  // 비밀번호 인증용 (OAuth 사용자는 null)
  password      String?

  // FDE Academy 전용 필드
  accessLevel   AccessLevel @default(FREE)

  // Relations
  accounts      Account[]
  sessions      Session[]
  progress      Progress[]
  subscription  Subscription?
  profile       Profile?

  // Community Relations
  posts         Post[]
  comments      Comment[]
  postLikes     PostLike[]
  commentLikes  CommentLike[]
  bookmarks     Bookmark[]
  mentionedIn   Mention[]  @relation("MentionedUser")
  mentionsMade  Mention[]  @relation("MentionerUser")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@map("users")
}

// NextAuth Account (OAuth)
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// NextAuth Session
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// NextAuth Verification Token
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// Profile (확장된 프로필 시스템)
// ============================================

model Profile {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 기본 정보
  headline      String?   // 한줄 소개 (예: "풀스택 개발자 | AI 엔지니어")
  bio           String?   @db.Text  // 자기소개

  // 역할 & 분류
  roleType      RoleType  @default(DEVELOPER)  // 역할 유형
  industry      String?   // 업종 (예: "IT/소프트웨어", "금융", "교육")
  location      String?   // 위치 (예: "서울", "부산", "원격")

  // 경력 정보
  jobTitle      String?   // 현재 직책
  company       String?   // 현재 회사명
  yearsOfExp    Int?      // 총 경력 연차

  // 네트워킹 정보
  isOpenToCollab  Boolean @default(false)  // 협업 가능 여부
  lookingFor      String[]  // 찾고 있는 것 (팀원, 투자자, 멘토, 스폰서, 프로젝트 등)
  interests       String[]  // 관심 분야 (AI, 데이터, 웹개발 등)
  canOffer        String[]  // 제공 가능한 것 (멘토링, 투자, 기술지원 등)

  // 외부 링크
  githubUrl       String?
  linkedinUrl     String?
  portfolioUrl    String?
  blogUrl         String?
  youtubeUrl      String?
  twitterUrl      String?
  companyUrl      String?   // 회사 홈페이지
  personalUrl     String?   // 개인 웹사이트

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  skills        UserSkill[]
  experiences   Experience[]
  educations    Education[]
  projects      Project[]
  services      Service[]
  certifications Certification[]

  @@map("profiles")
}

// 역할 유형
enum RoleType {
  DEVELOPER       // 개발자
  DESIGNER        // 디자이너
  MARKETER        // 마케터
  PM              // 기획자/PM
  DATA_SCIENTIST  // 데이터 사이언티스트
  RESEARCHER      // 연구자/교수
  FOUNDER         // 창업자
  INVESTOR        // 투자자
  STUDENT         // 학생
  OTHER           // 기타
}

// 경력
model Experience {
  id          String    @id @default(cuid())
  profileId   String
  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  company     String    // 회사명
  jobTitle    String    // 직책
  description String?   @db.Text  // 업무 설명
  startDate   DateTime  // 시작일
  endDate     DateTime? // 종료일 (null이면 현재 재직중)
  isCurrent   Boolean   @default(false)  // 현재 재직중
  location    String?   // 근무지

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("experiences")
}

// 학력
model Education {
  id          String    @id @default(cuid())
  profileId   String
  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  school      String    // 학교명
  degree      String?   // 학위 (학사, 석사, 박사 등)
  field       String?   // 전공
  startDate   DateTime? // 입학일
  endDate     DateTime? // 졸업일
  description String?   @db.Text  // 설명

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("educations")
}

// 프로젝트
model Project {
  id          String    @id @default(cuid())
  profileId   String
  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  title       String    // 프로젝트명
  description String?   @db.Text  // 설명
  role        String?   // 역할 (리드, 프론트엔드, 백엔드 등)
  techStack   String[]  // 사용 기술
  imageUrl    String?   // 대표 이미지
  demoUrl     String?   // 라이브 데모 URL
  githubUrl   String?   // GitHub URL
  startDate   DateTime? // 시작일
  endDate     DateTime? // 종료일

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("projects")
}

// 운영 중인 서비스
model Service {
  id          String    @id @default(cuid())
  profileId   String
  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  name        String    // 서비스명
  description String?   @db.Text  // 서비스 설명
  url         String?   // 서비스 URL
  logoUrl     String?   // 로고 이미지
  status      ServiceStatus @default(ACTIVE)  // 상태

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("services")
}

enum ServiceStatus {
  ACTIVE      // 운영중
  BETA        // 베타
  COMING_SOON // 준비중
  ARCHIVED    // 종료
}

// 자격증
model Certification {
  id          String    @id @default(cuid())
  profileId   String
  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  name        String    // 자격증명
  issuer      String?   // 발급기관
  issueDate   DateTime? // 취득일
  expiryDate  DateTime? // 만료일
  credentialUrl String? // 자격증 URL

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("certifications")
}

// 기술 스택 마스터
model Skill {
  id        String   @id @default(cuid())
  name      String   @unique  // 'Python', 'SQL', 'Neo4j' 등
  category  String?  // 'Language', 'Database', 'Framework' 등
  iconUrl   String?  // 아이콘 URL

  users     UserSkill[]

  @@map("skills")
}

// 사용자-기술 매핑
model UserSkill {
  id        String   @id @default(cuid())
  profileId String
  skillId   String
  level     SkillLevel @default(BEGINNER)

  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  skill     Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([profileId, skillId])
  @@map("user_skills")
}

enum SkillLevel {
  BEGINNER      // 초급
  INTERMEDIATE  // 중급
  ADVANCED      // 고급
  EXPERT        // 전문가
}

// ============================================
// Learning Progress (학습 진행)
// ============================================

model Progress {
  id        String   @id @default(cuid())
  userId    String
  taskId    String   // 'iterator-protocol-video', 'custom-iterator-code' 등
  weekSlug  String   // 'python-advanced'

  completed Boolean  @default(false)
  score     Int?     // 퀴즈 점수 (0-100)

  startedAt   DateTime  @default(now())
  completedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, taskId])
  @@index([userId])
  @@index([weekSlug])
  @@map("progress")
}

// ============================================
// Subscription & Payment (구독 및 결제)
// ============================================

model Subscription {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  plan          AccessLevel @default(FREE)
  status        SubStatus   @default(ACTIVE)

  // 결제 정보
  priceMonthly  Int?        // 월 구독료 (원)
  paymentMethod String?     // 'CARD', 'BANK', 'VIRTUAL_ACCOUNT'

  // 토스페이먼츠 연동
  tossCustomerKey String?   // 토스 고객키
  tossBillingKey  String?   // 자동결제용 빌링키

  // 기간
  startDate       DateTime    @default(now())
  endDate         DateTime?
  nextBillingDate DateTime?   // 다음 결제일
  cancelledAt     DateTime?

  // Relations
  payments      Payment[]

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@map("subscriptions")
}

// 결제 내역
model Payment {
  id              String   @id @default(cuid())
  subscriptionId  String
  subscription    Subscription @relation(fields: [subscriptionId], references: [id])

  // 토스페이먼츠 정보
  tossPaymentKey  String   @unique  // 결제 고유키
  orderId         String   @unique  // 주문번호
  orderName       String             // 주문명

  // 금액
  amount          Int      // 결제 금액
  discountAmount  Int      @default(0)  // 할인 금액

  // 상태
  status          PaymentStatus @default(READY)
  method          String?  // CARD, BANK, VIRTUAL_ACCOUNT

  // 카드 정보 (카드 결제 시)
  cardCompany     String?
  cardNumber      String?  // 마스킹된 번호

  // 타임스탬프
  requestedAt     DateTime @default(now())
  approvedAt      DateTime?
  cancelledAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("payments")
}

enum PaymentStatus {
  READY            // 결제 대기
  IN_PROGRESS      // 결제 진행 중
  DONE             // 결제 완료
  CANCELED         // 결제 취소
  PARTIAL_CANCELED // 부분 취소
  ABORTED          // 결제 승인 실패
  EXPIRED          // 결제 만료
}

// ============================================
// Community (커뮤니티)
// ============================================

// 카테고리
model Category {
  id          String   @id @default(cuid())
  name        String   @unique  // 'question', 'project', 'discussion'
  displayName String             // '질문', '프로젝트 모집', '자유 토론'
  description String?
  color       String?  // HEX 색상
  icon        String?  // 아이콘 이름
  order       Int      @default(0)

  posts       Post[]

  createdAt   DateTime @default(now())

  @@map("categories")
}

// 게시글
model Post {
  id          String   @id @default(cuid())
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])

  title       String
  content     String   @db.Text
  slug        String   @unique  // URL 슬러그

  // 상태
  isPublished Boolean  @default(true)
  isPinned    Boolean  @default(false)  // 공지사항
  isLocked    Boolean  @default(false)  // 댓글 잠금

  // 통계
  viewCount   Int      @default(0)
  likeCount   Int      @default(0)
  commentCount Int     @default(0)

  // Relations
  comments    Comment[]
  likes       PostLike[]
  bookmarks   Bookmark[]
  mentions    Mention[]
  tags        PostTag[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([authorId])
  @@index([categoryId])
  @@index([createdAt(sort: Desc)])
  @@map("posts")
}

// 댓글
model Comment {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  content   String   @db.Text

  // 대댓글
  parentId  String?
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")

  // 통계
  likeCount Int      @default(0)

  // Relations
  likes     CommentLike[]
  mentions  Mention[]

  isDeleted Boolean  @default(false)  // 소프트 삭제

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId])
  @@index([authorId])
  @@map("comments")
}

// 게시글 좋아요
model PostLike {
  id      String   @id @default(cuid())
  postId  String
  userId  String

  post    Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([postId, userId])
  @@map("post_likes")
}

// 댓글 좋아요
model CommentLike {
  id        String   @id @default(cuid())
  commentId String
  userId    String

  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([commentId, userId])
  @@map("comment_likes")
}

// 북마크
model Bookmark {
  id      String   @id @default(cuid())
  postId  String
  userId  String

  post    Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([postId, userId])
  @@map("bookmarks")
}

// 멘션 (@username)
model Mention {
  id            String   @id @default(cuid())
  mentionedId   String   // 멘션된 사용자
  mentionerId   String   // 멘션한 사용자

  postId        String?
  commentId     String?

  post          Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment       Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  mentioned     User     @relation("MentionedUser", fields: [mentionedId], references: [id], onDelete: Cascade)
  mentioner     User     @relation("MentionerUser", fields: [mentionerId], references: [id], onDelete: Cascade)

  isRead        Boolean  @default(false)

  createdAt     DateTime @default(now())

  @@map("mentions")
}

// 태그
model Tag {
  id    String   @id @default(cuid())
  name  String   @unique

  posts PostTag[]

  @@map("tags")
}

model PostTag {
  id      String @id @default(cuid())
  postId  String
  tagId   String

  post    Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@map("post_tags")
}

// ============================================
// Enums
// ============================================

enum AccessLevel {
  FREE       // 무료 (Phase 1 일부)
  BASIC      // 베이직 (Phase 1-2)
  PRO        // 프로 (Phase 1-4)
  ENTERPRISE // 엔터프라이즈 (전체)
}

enum SubStatus {
  ACTIVE     // 활성
  CANCELLED  // 해지됨
  EXPIRED    // 만료됨
  PAUSED     // 일시정지
}
